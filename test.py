import serial
import numpy as np
import binascii
import time
import math
import numpy as np
import matplotlib.pyplot as plt
dac_factor = 1.599 #DAC factor specific to emstat3



def process_U(data):
    potential_arr = []
    current_arr = []
    for U_data in data:
        current_overload = False
        current_underload = False
        potential = ((int(U_data[2:4], 16) * 256 + int(U_data[0:2], 16)) / 65536 * 4.096 - 2.048) * dac_factor
        current_range = 10 ** int(int(U_data[10:12], 16) & int('0F', 16))
        current = ((int(U_data[6:8], 16) * 256 + int(U_data[4:6], 16)) / 65536 * 4.096 - 2.048) * current_range / 10**(3)
        if U_data[10:12] == '01':
            current = current + 4.096 * current
        if U_data[10:12] == 'FF':
            current = current - 4.096 * current
        if (int(U_data[10:12], 16) & int('20', 16) == int('20', 16)):
            current_overload = True
            print("current overload")
        if (int(U_data[10:12], 16) & int('40', 16) == int('40', 16)):
            current_underload = True
            print("current underload")
        potential_arr.append(potential)
        current_arr.append(current)
    return potential_arr, current_arr

data = 'U8F70CEA50003998FUC17088A40003998FUF370EFA30003998FU257196A30003998FU577147A30003998FU897105A30003998FUBB71D9A20003998FUED7195A20003998FU1F727CA20003998FU51725BA20003998FU837241A20003998FUB57207A20003998FUE77209A20003998FU1973F8A10003998FU4B73E0A10003998FU7D73DEA10003998FUAF73C4A10003998FUE173B6A10003998FU1374AAA10003998FU4574A5A10003998FU777498A10003998FUA9748BA10003998FUDB748FA10003998FU0D7582A10003998FU3F757DA10003998FU717568A10003998FUA37567A10003998FUD5754EA10003998FU07764BA10003998FU39765CA10003998FU6B763AA10003998FU9D7633A10003998FUCF762CA10003998FU01771CA10003998FU337709A10003998FU6577F1A00003998FU9777ECA00003998FUC977E0A00003998FUFB77DBA00003998FU2D78BAA00003998FU5F78B3A00003998FU917891A00003998FUC37876A00003998FUF57853A00003998FU277952A00003998FU597942A00003998FU8B790DA00003998FUBD7908A00003998FUEF79E09F0003998FU217ABA9F0003998FU537AAA9F0003998FU857A759F0003998FUB77A659F0003998FUE97A339F0003998FU1B7B1D9F0003998FU4D7BEF9E0003998FU7F7BCD9E0003998FUB17BA29E0003998FUE37B7F9E0003998FU157C419E0003998FU477C1B9E0003998FU797CF49D0003998FUAB7CBB9D0003998FUDD7C7D9D0003998FU0F7D4E9D0003998FU417D129D0003998FU737DD39C0003998FUA57DA99C0003998FUD77D729C0003998FU097E359C0003998FU3B7E039C0003998FU6D7ED19B0003998FU9F7EAE9B0003998FUD17E859B0003998FU037F629B0003998FU357F489B0003998FU677F2E9B0003998FU997F0E9B0003998FUCB7F029B0003998FUFD7F129B0003998FU2F80109B0003998FU6180039B0003998FU9380149B0003998FUC580159B0003998FUF780239B0003998FU29812E9B0003998FU5B813C9B0003998FU8D81479B0003998FUBF81369B0003998FUF1812D9B0003998FU2382F49A0003998FU5582D99A0003998FU8782939A0003998FUB9823F9A0003998FUEB82DF990003998FU1D8370990003998FU4F83FE980003998FU81836B980003998FUB383EC970003998FUE58357970003998FU1784CF960003998FU498454960003998FU7B84CC950003998FUAD8468950003998FUDF84E5940003998FU118586940003998FU43851D940003998FU7585CA930003998FUA78582930003998FUD9853E930003998FU0B8612930003998FU3D86CE920003998FU6F869F920003998FUA1866B920003998FUD38636920003998FU058722920003998FU3787FD910003998FU6987DE910003998FU9B87BA910003998FUCD879E910003998FUFF8792910003998FU31887B910003998FU638875910003998FU958856910003998FUC78865910003998FUF98840910003998FU2B894D910003998FU5D8932910003998FU8F8932910003998FUC1891C910003998FUF38927910003998FU258A29910003998FU578A14910003998FU898A20910003998FUBB8A13910003998FUED8A11910003998FU1F8B18910003998FU518B17910003998FU838B18910003998FUB58B1D910003998FUE78B12910003998FU198C02910003998FU4B8C0B910003998FU7D8C06910003998FUAF8C0F910003998FUE18C1A910003998FU138D1E910003998FU458D2A910003998FU778D1C910003998FUA98D24910003998FUDB8D25910003998FU0D8E31910003998FU3F8E4C910003998FU718E48910003998FUA38E5C910003998FUD58E59910003998FU078F75910003998FU398F82910003998FU6B8F91910003998FU9D8FB3910003998F'

U_data = data.split('U')
potential, current = process_U(U_data[1:])
print(potential, current)
plt.plot(potential, current)
plt.show()
